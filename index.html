<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - theboiismc.com</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Set default font to Inter -->
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
</head>
<body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <!-- This is the root element where your React app will be mounted -->
    <div id="root"></div>

    <!-- Load React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX transformation in development/browser environments -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!--
        This script now contains your entire React App component and renders it.
        By embedding the App component directly here, we ensure Babel can process the JSX
        immediately without needing to fetch an external file, resolving previous errors.
    -->
    <script type="text/babel">
        // Destructure useState and useEffect from React, as they are globally available
        // when React is loaded via CDN.
        const { useState, useEffect } = React;

        const AUTHENTIK_DOMAIN = 'accounts.theboiismc.com'; // Your Authentik instance domain
        const CLIENT_ID = '7h5UUFHApH8lck0fNltULeyCMrlTaP5J3HqfFSYL'; // Replace with the Client ID from Authentik provider
        const REDIRECT_URI = 'https://myaccount.theboiismc.com/callback'; // Your app's callback URL
        const SCOPES = 'openid profile email'; // Request basic user info

        function App() {
          const [user, setUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [error, setError] = useState(null);
          const [activeTab, setActiveTab] = useState('settings'); // 'settings', 'personalization', 'security'

          useEffect(() => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            const errorParam = urlParams.get('error'); // Check for errors from Authentik

            const handleAuthCallback = async () => {
              setLoading(true);
              setError(null);

              if (code && state) { // This is a redirect from Authentik with a code (successful login or silent login)
                const storedVerifier = sessionStorage.getItem('pkce_code_verifier');
                const storedState = sessionStorage.getItem('oauth_state');

                if (state === storedState && storedVerifier) {
                  try {
                    // Exchange authorization code for tokens
                    const tokenResponse = await fetch(`https://${AUTHENTIK_DOMAIN}/application/o/token/`, {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                      },
                      body: new URLSearchParams({
                        grant_type: 'authorization_code',
                        client_id: 7h5UUFHApH8lck0fNltULeyCMrlTaP5J3HqfFSYL,
                        redirect_uri: REDIRECT_URI,
                        code: code,
                        code_verifier: storedVerifier, // PKCE verifier
                      }).toString(),
                    });

                    if (!tokenResponse.ok) {
                      const errorData = await tokenResponse.json();
                      throw new Error(`Failed to get tokens: ${errorData.error_description || tokenResponse.statusText}`);
                    }

                    const tokenData = await tokenResponse.json();
                    const accessToken = tokenData.access_token;

                    // Fetch user info
                    const userInfoResponse = await fetch(`https://${AUTHENTIK_DOMAIN}/application/o/userinfo/`, {
                      headers: {
                        'Authorization': `Bearer ${accessToken}`,
                      },
                    });

                    if (!userInfoResponse.ok) {
                      const errorData = await userInfoResponse.json();
                      throw new Error(`Failed to get user info: ${errorData.error_description || userInfoResponse.statusText}`);
                    }

                    const userData = await userInfoResponse.json();
                    setUser(userData);

                    // Clean up session storage
                    sessionStorage.removeItem('pkce_code_verifier');
                    sessionStorage.removeItem('oauth_state');

                    // Clean URL from OAuth parameters
                    window.history.replaceState({}, document.title, window.location.pathname);

                  } catch (err) {
                    console.error("Authentication callback error:", err);
                    setError(`Authentication failed: ${err.message}. Please try logging in again.`);
                    setUser(null); // Clear user on error
                  } finally {
                    setLoading(false);
                  }
                } else {
                  setError("State mismatch or missing PKCE verifier. Possible security issue or session expired. Please log in again.");
                  setLoading(false);
                  window.history.replaceState({}, document.title, window.location.pathname);
                }
              } else if (errorParam === 'login_required' || errorParam === 'interaction_required') {
                // Authentik explicitly told us user interaction is needed (no active session)
                // This happens if prompt=none was used and no session existed.
                setError("You are not logged in or your session has expired. Please log in.");
                setLoading(false);
                window.history.replaceState({}, document.title, window.location.pathname);
              } else if (!user) { // No code, no error, and no user set. Attempt silent authentication.
                // Generate PKCE verifier and challenge
                const codeVerifier = generateCodeVerifier();
                const codeChallenge = base64URLEncode(
                  await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
                );
                const newState = Math.random().toString(36).substring(2); // Simple random state

                // Store verifier and state for later validation
                sessionStorage.setItem('pkce_code_verifier', codeVerifier);
                sessionStorage.setItem('oauth_state', newState);

                // Construct the silent authentication URL with prompt=none
                const silentAuthUrl = `https://${AUTHENTIK_DOMAIN}/application/o/authorize/?` +
                  `response_type=code&` +
                  `client_id=${7h5UUFHApH8lck0fNltULeyCMrlTaP5J3HqfFSYL}&` +
                  `redirect_uri=${REDIRECT_URI}&` +
                  `scope=${SCOPES}&` +
                  `state=${newState}&` +
                  `code_challenge=${codeChallenge}&` +
                  `code_challenge_method=S256&` +
                  `prompt=none`; // This is the key for silent authentication

                // Redirect the main window for silent authentication.
                // If the user is not logged in, Authentik will redirect back with error=login_required
                // which the 'else if (errorParam === 'login_required')' block above will catch.
                window.location.href = silentAuthUrl;
              } else {
                // User is already set (e.g., from a previous successful callback in the same session),
                // or no relevant URL params. Just finish loading.
                setLoading(false);
              }
            };

            handleAuthCallback();
          }, [user]); // Add user to dependency array to re-run if user state changes (e.g., after logout)

          const generateCodeVerifier = () => {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < 128; i++) { // 128 characters for verifier
              result += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            return result;
          };

          const sha256 = async (plain) => {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hexHash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hexHash;
          };

          const base64URLEncode = (buffer) => {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer)))
              .replace(/\+/g, '-')
              .replace(/\//g, '_')
              .replace(/=+$/, '');
          };

          const handleLogin = async () => {
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = base64URLEncode(
              await crypto.subtle.digest('SHA-256', new TextEncoder().encode(codeVerifier))
            );
            const state = Math.random().toString(36).substring(2); // Simple random state

            // Store verifier and state for later validation
            sessionStorage.setItem('pkce_code_verifier', codeVerifier);
            sessionStorage.setItem('oauth_state', state);

            const authUrl = `https://${AUTHENTIK_DOMAIN}/application/o/authorize/?` +
              `response_type=code&` +
              `client_id=${7h5UUFHApH8lck0fNltULeyCMrlTaP5J3HqfFSYL}&` +
              `redirect_uri=${REDIRECT_URI}&` +
              `scope=${SCOPES}&` +
              `state=${state}&` +
              `code_challenge=${codeChallenge}&` +
              `code_challenge_method=S256`;

            window.location.href = authUrl;
          };

          const handleLogout = () => {
            setUser(null);
            // For a full logout, you might also want to redirect to Authentik's logout endpoint
            // or clear Authentik session. Example:
            // window.location.href = `https://${AUTHENTIK_DOMAIN}/application/o/logout/?post_logout_redirect_uri=${window.location.origin}`;
          };

          if (loading) {
            return (
              <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                <div className="text-center text-lg font-semibold text-gray-700">Loading account data...</div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100 font-sans text-gray-800 flex flex-col">
              {/* Header */}
              <header className="bg-white shadow-md p-4 flex justify-between items-center rounded-b-lg">
                <h1 className="text-2xl font-bold text-indigo-700">myaccount.theboiismc.com</h1>
                {user ? (
                  <button
                    onClick={handleLogout}
                    className="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 transition duration-200"
                  >
                    Logout
                  </button>
                ) : (
                  <button
                    onClick={handleLogin}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200"
                  >
                    Login with Authentik
                  </button>
                )}
              </header>

              {/* Main Content */}
              <main className="flex-grow p-6">
                {error && (
                  <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md relative mb-6" role="alert">
                    <strong className="font-bold">Error:</strong>
                    <span className="block sm:inline ml-2">{error}</span>
                  </div>
                )}

                {user ? (
                  <div className="bg-white rounded-lg shadow-xl p-8 max-w-4xl mx-auto">
                    <h2 className="text-3xl font-bold text-gray-900 mb-6 text-center">Welcome, {user.preferred_username || user.name || user.email}!</h2>

                    {/* User Info Card */}
                    <div className="mb-8 bg-blue-50 p-6 rounded-lg border border-blue-200">
                      <h3 className="text-xl font-semibold text-blue-800 mb-4">Your Profile Information</h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                        <p><strong>Username:</strong> {user.preferred_username || 'N/A'}</p>
                        <p><strong>Email:</strong> {user.email || 'N/A'}</p>
                        <p><strong>Full Name:</strong> {user.name || 'N/A'}</p>
                        <p><strong>Given Name:</strong> {user.given_name || 'N/A'}</p>
                        <p><strong>Family Name:</strong> {user.family_name || 'N/A'}</p>
                        <p><strong>Sub (User ID):</strong> {user.sub || 'N/A'}</p>
                      </div>
                    </div>

                    {/* Navigation Tabs */}
                    <div className="flex border-b border-gray-200 mb-6">
                      <button
                        className={`py-3 px-6 text-lg font-medium ${activeTab === 'settings' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}
                        onClick={() => setActiveTab('settings')}
                      >
                        Account Settings
                      </button>
                      <button
                        className={`py-3 px-6 text-lg font-medium ${activeTab === 'personalization' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}
                        onClick={() => setActiveTab('personalization')}
                      >
                        Personalization
                      </button>
                      <button
                        className={`py-3 px-6 text-lg font-medium ${activeTab === 'security' ? 'border-b-2 border-indigo-600 text-indigo-600' : 'text-gray-600 hover:text-indigo-600'}`}
                        onClick={() => setActiveTab('security')}
                      >
                        Security
                      </button>
                    </div>

                    {/* Tab Content */}
                    <div>
                      {activeTab === 'settings' && (
                        <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                          <h3 className="text-2xl font-semibold text-gray-800 mb-4">Account Settings</h3>
                          <p className="text-gray-700">Manage your basic account information, contact details, and preferences here. This is where you'd integrate forms to update email, name, etc.</p>
                          <div className="mt-4 p-4 border border-gray-300 rounded-md bg-white">
                            <p className="font-medium text-gray-900">Example Setting:</p>
                            <label htmlFor="email_pref" className="block text-sm font-medium text-gray-700 mt-2">
                              Receive Email Notifications:
                            </label>
                            <select id="email_pref" name="email_pref" className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                              <option>Yes</option>
                              <option>No</option>
                              <option>Digest Only</option>
                            </select>
                            <button className="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Save Settings</button>
                          </div>
                        </div>
                      )}

                      {activeTab === 'personalization' && (
                        <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                          <h3 className="text-2xl font-semibold text-gray-800 mb-4">Personalization</h3>
                          <p className="text-gray-700">Customize your experience, themes, and display preferences. You could link to other services here.</p>
                          <div className="mt-4 p-4 border border-gray-300 rounded-md bg-white">
                            <p className="font-medium text-gray-900">Example Personalization:</p>
                            <label htmlFor="theme_pref" className="block text-sm font-medium text-gray-700 mt-2">
                              Preferred Theme:
                            </label>
                            <select id="theme_pref" name="theme_pref" className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                              <option>Light</option>
                              <option>Dark</option>
                              <option>System Default</option>
                            </select>
                            <button className="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Apply Theme</button>
                          </div>
                        </div>
                      )}

                      {activeTab === 'security' && (
                        <div className="bg-gray-50 p-6 rounded-lg border border-gray-200">
                          <h3 className="text-2xl font-semibold text-gray-800 mb-4">Security</h3>
                          <p className="text-gray-700">Review your recent activity, manage connected devices, and update security settings like multi-factor authentication.</p>
                          <div className="mt-4 p-4 border border-gray-300 rounded-md bg-white">
                            <p className="font-medium text-gray-900">Example Security Option:</p>
                            <button className="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600">Review Recent Activity</button>
                            <button className="ml-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">Manage 2FA</button>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="bg-white rounded-lg shadow-xl p-8 max-w-xl mx-auto text-center">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">Welcome to myaccount.theboiismc.com</h2>
                    <p className="text-gray-700 mb-6">Please log in to manage your account settings, personalization, and security preferences.</p>
                    <button
                      onClick={handleLogin}
                      className="px-6 py-3 bg-indigo-600 text-white text-lg font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 transition duration-200"
                    >
                      Log In with Authentik
                    </button>
                  </div>
                )}
              </main>

              {/* Footer */}
              <footer className="bg-gray-800 text-white text-center p-4 mt-8 rounded-t-lg">
                <p>&copy; {new Date().getFullYear()} theboiismc.com. All rights reserved.</p>
              </footer>
            </div>
          );
        }

        // Get the root element
        const rootElement = document.getElementById('root');

        // Create a root and render the App component
        const root = ReactDOM.createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
